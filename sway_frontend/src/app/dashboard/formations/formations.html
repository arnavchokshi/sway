<div class="formations-container">
  <div class="segments-grid">
    <!-- List all segments -->
    <ng-container *ngIf="segments.length > 0; else noSegments">
      <div class="segment-card"
           *ngFor="let segment of segments; let i = index"
           (click)="goToSegment(segment._id)"
           [class.dragging]="draggingIndex === i"
           [class.drag-over]="dragOverIndex === i"
           draggable="true"
           (dragstart)="onDragStart($event, i)"
           (dragover)="onDragOver($event, i)"
           (drop)="onDrop($event, i)"
           (dragend)="onDragEnd()">
        <div class="segment-grid-bg"></div>
        <!-- Segment order badge -->
        <div class="segment-order-badge">
          {{ i + 1 }}
        </div>

        <!-- User in segment indicator -->
        <div class="user-in-segment-indicator" *ngIf="isUserInSegment(segment)" title="You are in this segment">
          <i class="fas fa-user"></i>
        </div>

        <button class="delete-segment-btn" 
                *ngIf="isCaptain" 
                [class.confirming]="isDeleteConfirming && segmentToDelete === segment._id"
                (click)="deleteSegment(segment._id); $event.stopPropagation()"
                [title]="(isDeleteConfirming && segmentToDelete === segment._id) ? 'Click again to confirm delete' : 'Delete segment'">
          <span class="material-icons" *ngIf="!(isDeleteConfirming && segmentToDelete === segment._id)">delete</span>
          <span *ngIf="isDeleteConfirming && segmentToDelete === segment._id">Confirm Delete</span>
        </button>
        <div class="segment-name">{{ segment.name }}</div>
        <!-- Style pills at the bottom -->
        <div class="segment-style-pills" *ngIf="segment.stylesInSegment?.length">
          <span class="style-pill" *ngFor="let styleName of segment.stylesInSegment"
                [ngStyle]="{ 'background-color': getStyleColor(styleName) }">
            {{ styleName }}
          </span>
        </div>
      </div>
    </ng-container>
    <ng-template #noSegments>
      <div class="no-segments">No segments yet. Create your first segment!</div>
    </ng-template>

    <!-- New Segment Card - Only visible to captains -->
    <div class="segment-card new-segment" *ngIf="isCaptain" (click)="goToCreateSegment()">
      <div class="card-content">
        <i class="fas fa-plus"></i>
        <span>Add New Segment</span>
      </div>
    </div>
  </div>

  <!-- Segment Creation Modal -->
  <div class="modal-backdrop" *ngIf="showSegmentModal">
    <div class="modal frosted-glass-modal">
      <h2>Create New Segment</h2>
      <form (ngSubmit)="submitSegmentModal()">
        <label>
          Segment Name
          <input type="text" [(ngModel)]="newSegmentName" name="name" required />
        </label>
        <label>
          Dimensions (ft)
          <div style="display: flex; align-items: center; gap: 8px;">
            <input type="number" [(ngModel)]="newSegmentDepth" name="depth" min="1" required style="width: 60px;" />
            <span style="font-weight: bold;">x</span>
            <input type="number" [(ngModel)]="newSegmentWidth" name="width" min="1" required style="width: 60px;" />
          </div>
        </label>
        <div class="styles-section-modal">
          <div style="font-weight: 500; margin-bottom: 6px; display: flex; align-items: center; gap: 10px; position: relative;">
            <span style="font-size: 1.1em; font-weight: 600;">Styles</span>
            <span style="font-size: 0.9em; color: #b3b3c6; font-weight: 400;">(Add these to view by skill)</span>
            <button type="button" class="add-style-btn" (click)="showAddStyleInput = true" *ngIf="isCaptain && !showAddStyleInput" style="margin-left: auto; background: none; border: none; color: #6366f1; font-size: 1.5em; cursor: pointer;">+</button>
          </div>
          <div class="styles-list-modal" *ngIf="teamStyles.length > 0 || showAddStyleInput">
            <div class="styles-grid">
              <div *ngFor="let style of teamStyles; let i = index" class="style-checkbox-modal"
                   [class.selected]="isStyleSelected(style)"
                   (click)="toggleStyle(style, !isStyleSelected(style))">
                <span class="style-color-modal" [style.background]="style.color"></span>
                <span>{{ style.name }}</span>
                <button type="button" class="delete-single-style-btn" (click)="deleteStyle(style, $event)" *ngIf="isCaptain" title="Delete this style">
                  <span class="material-icons">delete</span>
                </button>
              </div>
            </div>
            <div *ngIf="showAddStyleInput" class="style-checkbox-modal new-style-card" style="position: relative; min-width: 120px;">
              <input type="text" [(ngModel)]="newStyleName" name="newStyleName" placeholder="Style name" style="flex: 1; margin-left: -80px; width: 150px;padding: 0.5em 1.2em 0.5em 0.8em; border-radius: 10px; border: 1.5px solid #6366f1; font-size: 1.08em; font-weight: 600; background: rgba(255,255,255,0.13); color: #fff; outline: none;" (keydown.enter)="addNewStyle()" aria-label="New style name" autofocus />
              <button type="button" (click)="addNewStyle()" class="submit-btn" style="position: absolute; right: 32px; top: 50%; transform: translateY(-50%); padding: 0.3em 0.9em; font-size: 1em;">Add</button>
              <button type="button" (click)="cancelAddStyle()" class="close-style-btn" aria-label="Cancel new style" style="position: absolute; right: 4px; top: 4px; background: none; border: none; color: #b3b3c6; font-size: 1.2em; cursor: pointer;">&#10005;</button>
            </div>
          </div>
        </div>
        <div class="modal-actions">
          <button type="submit" class="submit-btn">Create</button>
          <button type="button" (click)="closeSegmentModal()" class="cancel-btn">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Mobile Warning Modal -->
  <div class="modal-backdrop" *ngIf="showMobileWarningModal">
    <div class="modal frosted-glass-modal mobile-warning-modal">
      <div class="mobile-warning-header">
        <span class="material-icons warning-icon">warning</span>
        <h2>Sorry Cap</h2>
      </div>
      <div class="mobile-warning-content">
        <p class="main-message">
          For the best editing experience use  laptop
        </p>
        <p class="sub-message">
          The segment editor has complex functionality that works better on larger screens with keyboard and mouse support.
        </p>
        <div class="mobile-info-box">
          <span class="material-icons info-icon">info</span>
          <span>You can view segment as member though</span>
        </div>
      </div>
      <div class="modal-actions mobile-actions">
        <button type="button" (click)="closeMobileWarningModal()" class="primary-btn">
          <span class="material-icons">laptop</span>
          Use Desktop Instead
        </button>
        <button type="button" (click)="viewAsMemeber()" class="secondary-btn">
          View as Member
        </button>
      </div>
    </div>
  </div>
</div> 