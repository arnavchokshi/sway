<!-- Dashboard Layout -->
<div class="dashboard-bg">
  <!-- Top Panel -->
  <div class="top-panel">
    <div class="panel-content">
      <img src="assets/logoName.png" alt="Sway Logo" class="dashboard-logo">
      <div class="panel-actions">
        <button class="panel-btn membership-btn" (click)="navigateToMembershipPlan()">
          <i class="fas fa-crown"></i> Membership Plan
        </button>
        <button *ngIf="isCaptain" class="panel-btn edit-team-btn" (click)="navigateToEditRoster()">
          <i class="fas fa-users"></i> Edit Team
        </button>
        <div class="join-code-display" *ngIf="team">
          Join Code: <span class="join-code clickable" (click)="openJoinCodeModal()">{{ team.joinCode }}</span>
        </div>
        <!-- User Profile Icon -->
        <div class="profile-container" (click)="toggleProfileDropdown()" tabindex="0">
          <div class="profile-icon">
            {{ userInitial }}
          </div>
          <span class="dropdown-arrow">
            <i class="fas fa-chevron-down"></i>
          </span>
          <div class="profile-dropdown" *ngIf="showProfileDropdown" (click)="$event.stopPropagation()">
            <button class="dropdown-item" (click)="showInfoModal = true; closeProfileDropdown()">
              <i class="fas fa-info-circle"></i> Help
            </button>
            <button class="dropdown-item" (click)="signOut(); closeProfileDropdown()">
              <i class="fas fa-sign-out-alt"></i> Sign Out
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sets Section -->
  <div class="sets-section">
    <div class="sets-header">
      <h1 class="sets-title"></h1>
    </div>
    
    <div class="sets-container">
      <ng-container *ngIf="sets.length > 0; else noSets">
        <div class="set-row" *ngFor="let set of sets; let setIndex = index">
          <div class="set-content" [class.grayed-out]="!isSetAccessible(set)">
            <div class="set-header">
              <div class="set-info">
                <h3 class="set-name">{{ set.name }}</h3>
                <div class="set-stats">
                  <span class="segment-count">{{ getSegmentsForSet(set._id).length }} segments</span>
                  <span class="total-duration">{{ getTotalDuration(set._id) }}s total</span>
                </div>
              </div>
              <div class="set-actions">
                <button class="add-segment-btn" *ngIf="isCaptain" (click)="onSetClick(set)">
                  <i class="fas fa-plus"></i> Add Segment
                </button>
                <button class="set-menu-btn" *ngIf="isCaptain" (click)="toggleSetMenu(set._id)">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
                <div class="set-menu-dropdown" *ngIf="activeSetMenu === set._id" (clickOutside)="activeSetMenu = null">
                  <button (click)="editSet(set._id)">
                    <i class="fas fa-edit"></i> Edit Set
                  </button>
                  <button (click)="deleteSet(set._id)" class="delete-option">
                    <i class="fas fa-trash"></i> Delete Set
                  </button>
                </div>
              </div>
            </div>
            
            <div class="segments-in-set">
              <ng-container *ngIf="getSegmentsForSet(set._id).length > 0; else noSegmentsInSet">
                <div class="segment-card-enhanced"
                     *ngFor="let segment of getSegmentsForSet(set._id); let segIndex = index"
                     [attr.data-segment-id]="segment._id"
                     [class.dragging]="draggingSegmentIndex === segIndex && draggingSetId === set._id"
                     [class.drag-over]="dragOverIndex === segIndex && dragOverSetId === set._id"
                     [class.grayed-out]="!isSegmentAccessible(segment)"
                     draggable="true"
                     (dragstart)="onSegmentDragStart($event, segIndex, set._id, segment._id)"
                     (dragover)="onSegmentDragOver($event, segIndex, set._id)"
                     (drop)="onSegmentDrop($event, segIndex, set._id)"
                     (dragend)="onSegmentDragEnd()"
                     (click)="onSegmentClick(segment)">
                  <div class="segment-grid-bg"></div>
                  <div class="segment-number">{{ segIndex + 1 }}</div>
                  
                  <!-- User in segment indicator -->
                  <div class="user-in-segment-indicator" *ngIf="isUserInSegment(segment)" title="You are in this segment">
                    <i class="fas fa-user"></i>
                  </div>
                  
                  <!-- Privacy toggle eye icon next to number -->
                  <button class="privacy-toggle-btn" 
                          *ngIf="isCaptain"
                          (click)="toggleSegmentPrivacy(segment._id, segment.isPublic); $event.stopPropagation()" 
                          [title]="segment.isPublic ? 'Make segment private' : 'Make segment public'">
                    <i class="fas" [class.fa-eye]="segment.isPublic" [class.fa-eye-slash]="!segment.isPublic"></i>
                  </button>
                  
                  <!-- Drag handle dots in top center -->
                  <div class="drag-handle" *ngIf="isCaptain">
                    <div class="drag-dot"></div>
                    <div class="drag-dot"></div>
                    <div class="drag-dot"></div>
                    <div class="drag-dot"></div>
                    <div class="drag-dot"></div>
                    <div class="drag-dot"></div>
                  </div>
                  
                  <!-- Delete button in top right corner -->
                  <button class="delete-btn" 
                          *ngIf="isCaptain" 
                          [class.confirming]="isDeleteConfirming && segmentToDelete === segment._id"
                          (click)="deleteSegment(segment._id); $event.stopPropagation()" 
                          [title]="(isDeleteConfirming && segmentToDelete === segment._id) ? 'Click again to confirm delete' : 'Delete segment'">
                    <i class="fas fa-trash" *ngIf="!(isDeleteConfirming && segmentToDelete === segment._id)"></i>
                    <span *ngIf="isDeleteConfirming && segmentToDelete === segment._id">Confirm Delete</span>
                  </button>
                  
                  <div class="segment-main-content">
                    <h4 class="segment-title">{{ segment.name }}</h4>
                  </div>
                  
                  <!-- Style pills in bottom left corner -->
                  <div class="segment-style-pills" *ngIf="segment.stylesInSegment?.length">
                    <span class="style-pill" *ngFor="let styleName of segment.stylesInSegment"
                          [ngStyle]="{ 'background-color': getStyleColor(styleName) }">
                      {{ styleName }}
                    </span>
                  </div>
                  
                  <!-- Duration and Edit button in bottom right -->
                  <div class="segment-bottom-right">
                    <div class="segment-duration">{{ getSegmentDuration(segment) }}s</div>
                  </div>
                </div>
                
                <!-- Arrow to next set -->
                <div class="next-set-arrow" *ngIf="setIndex < sets.length - 1">
                  <i class="fas fa-arrow-right"></i>
                </div>
              </ng-container>
              
              <ng-template #noSegmentsInSet>
                <div class="no-segments-in-set">
                  <span>No segments in this set</span>
                  
                </div>
              </ng-template>
            </div>
          </div>
        </div>
        
        <!-- Create New Set button at the bottom -->
        <div class="create-set-bottom" *ngIf="isCaptain">
          <button class="add-set-btn-bottom" (click)="openSetModal()">
            <i class="fas fa-plus"></i> Create New Set
          </button>
        </div>
      </ng-container>
      
      <ng-template #noSets>
        <div class="no-sets">
          <span>No sets created yet</span>
          <button *ngIf="isCaptain" class="create-first-set-btn" (click)="openSetModal()">
            <i class="fas fa-plus"></i> Create Your First Set
          </button>
        </div>
      </ng-template>
    </div>
  </div>

  <!-- Set Creation Modal -->
  <div class="modal-backdrop" *ngIf="showSetModal">
    <div class="modal frosted-glass-modal">
      <h2>{{ editingSet ? 'Edit Set' : 'Create New Set' }}</h2>
      <form (ngSubmit)="submitSetModal()">
        <label>
          Set Name
          <input type="text" [(ngModel)]="newSetName" name="name" required />
        </label>
        <div class="modal-actions">
          <button type="submit" class="submit-btn">{{ editingSet ? 'Update' : 'Create' }}</button>
          <button type="button" (click)="closeSetModal()" class="cancel-btn">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Segment Creation Modal -->
  <div class="modal-backdrop" *ngIf="showSegmentModal">
    <div class="modal modern-segment-modal">
      <div class="modal-header">
        <div class="modal-title">
          <i class="fas fa-music"></i>
          <h2>Create New Segment</h2>
        </div>
        <button type="button" class="modal-close-btn" (click)="closeSegmentModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <form (ngSubmit)="submitSegmentModal()" class="segment-form">
        <!-- Main Content Row -->
        <div class="form-main-row">
          <!-- Left Side - Name and Settings -->
          <div class="form-left">
            <!-- Segment Name -->
            <div class="form-group">
              <label class="form-label">Segment Name <span class="required">*</span></label>
              <input 
                type="text" 
                [(ngModel)]="newSegmentName" 
                name="name" 
                required 
                class="form-input"
                placeholder="e.g., Opening Formation, Finale"
              />
            </div>

            <!-- Public/Private Toggle -->
            <div class="form-group">
              <div class="visibility-toggle">
                <div class="toggle-icon">
                  <i class="fas" [class.fa-eye]="newSegmentIsPublic" [class.fa-eye-slash]="!newSegmentIsPublic"></i>
                </div>
                <div class="toggle-content">
                  <h3>{{ newSegmentIsPublic ? 'Public Segment' : 'Private Segment' }}</h3>
                  <p>{{ newSegmentIsPublic ? 'Visible to the full team' : 'Only visible to captains' }}</p>
                </div>
                <div class="toggle-switch" (click)="newSegmentIsPublic = !newSegmentIsPublic">
                  <div class="toggle-track" [class.active]="newSegmentIsPublic">
                    <div class="toggle-thumb"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Dimensions -->
            <div class="form-group dimensions-section">
              <div class="dimensions-row">
                <div class="dimension-field">
                  <label class="form-label">Width</label>
                  <input 
                    type="number" 
                    [(ngModel)]="newSegmentWidth" 
                    name="width" 
                    min="1" 
                    required
                    class="form-input-small"
                  />
                </div>
                <div class="dimension-field">
                  <label class="form-label">Height</label>
                  <input 
                    type="number" 
                    [(ngModel)]="newSegmentDepth" 
                    name="depth" 
                    min="1" 
                    required
                    class="form-input-small"
                  />
                </div>
                <div class="dimension-field">
                  <label class="form-label">Divisions</label>
                  <input 
                    type="number" 
                    [(ngModel)]="newSegmentDivisions" 
                    name="divisions" 
                    min="1" 
                    required
                    class="form-input-small"
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- Right Side - Dance Styles -->
          <div class="form-right">
            <div class="form-group">
              <div class="styles-header">
                <label class="form-label">Dance Style <span class="required">*</span></label>
                                 <p class="styles-subheader">Add to view dancers skill level on chosen styles</p>
              </div>
              
              <div class="styles-grid-modern">
                <div *ngFor="let style of teamStyles" 
                     class="style-badge"
                     [class.selected]="isStyleSelected(style)"
                     (click)="toggleStyle(style, !isStyleSelected(style))">
                  <div class="style-circle" [style.background]="style.color"></div>
                  <span class="style-name">{{ style.name }}</span>
                </div>
              </div>

              <!-- Add New Style Button -->
              <div class="add-style-section" *ngIf="isCaptain">
                <div class="add-new-style-btn" 
                     *ngIf="!showAddStyleInput"
                     (click)="showAddStyleInput = true">
                  <i class="fas fa-plus"></i>
                  <span>Add New Style</span>
                </div>

                <!-- Add Style Input -->
                <div *ngIf="showAddStyleInput" class="add-style-input">
                  <input 
                    type="text" 
                    [(ngModel)]="newStyleName" 
                    name="newStyleName" 
                    placeholder="Style name"
                    class="style-input"
                    (keydown.enter)="addNewStyle()"
                    autofocus
                  />
                  <button type="button" (click)="addNewStyle()" class="add-style-confirm">
                    <i class="fas fa-check"></i>
                  </button>
                  <button type="button" (click)="cancelAddStyle()" class="add-style-cancel">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Bottom Row: Validation Message and Action Buttons -->
        <div class="modal-bottom-row">
          <div class="validation-message" *ngIf="!newSegmentName || newSegmentStyles.length === 0">
            Please fill in segment name and select a style
          </div>
          <div class="modal-actions-modern">
            <button type="button" (click)="closeSegmentModal()" class="btn-cancel">Cancel</button>
            <button type="submit" class="btn-create" [disabled]="!newSegmentName || newSegmentStyles.length === 0">
              Create Segment
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Mobile Warning Modal -->
  <div class="modal-backdrop" *ngIf="showMobileWarningModal">
    <div class="modal frosted-glass-modal mobile-warning-modal">
      <div class="mobile-warning-header">
        <span class="material-icons warning-icon">warning</span>
        <h2>Sorry Cap</h2>
      </div>
      <div class="mobile-warning-content">
        <p class="main-message">
          For the best editing experience use laptop
        </p>
        <p class="sub-message">
          The segment editor has complex functionality that works better on larger screens with keyboard and mouse support.
        </p>
        <div class="mobile-info-box">
          <span class="material-icons info-icon">info</span>
          <span>You can view segment as member though</span>
        </div>
      </div>
      <div class="modal-actions mobile-actions">
        <button type="button" (click)="closeMobileWarningModal()" class="primary-btn">
          <span class="material-icons">laptop</span>
          Use Desktop Instead
        </button>
        <button type="button" (click)="viewAsMemeber()" class="secondary-btn">
          View as Member
        </button>
      </div>
    </div>
  </div>

  <!-- Info Modal -->
  <div class="info-modal-overlay" *ngIf="showInfoModal" (click)="showInfoModal = false">
    <div class="info-modal-popup" (click)="$event.stopPropagation()">
      <div class="info-modal-header">
        <h3>Getting Started with Sway</h3>
        <button class="close-btn" (click)="showInfoModal = false">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="info-modal-content">
        <div class="info-item">
          <i class="fas fa-folder-plus"></i>
          <div class="info-text">
            <strong>Step 1: Create Sets</strong>
            <p>Sets are like folders that organize your choreography. Sets hold connected semgnets and represent your full per.</p>
          </div>
        </div>
        <div class="info-item">
          <i class="fas fa-music"></i>
          <div class="info-text">
            <strong>Step 2: Add Segments to Sets</strong>
            <p>Click "Add Segment" on any set to create formations for your different segments/songs. All segments inside a set are connected to each other.</p>
          </div>
        </div>
        <div class="info-item">
          <i class="fas fa-users"></i>
          <div class="info-text">
            <strong>Step 3: Build Formations</strong>
            <p>Click on any segment to open the formation editor where you can position your team members and create formations.</p>
          </div>
        </div>
        <div class="info-item">
          <i class="fas fa-palette"></i>
          <div class="info-text">
            <strong>Dance Styles & Skills</strong>
            <p>Add dance styles to segments to see team members' skill levels, helping you make better formation decisions.</p>
          </div>
        </div>
        <div class="info-item tip-bubble">
          <i class="fas fa-lightbulb"></i>
          <div class="info-text">
            <strong>Tip:</strong>
            <p>Heads up - you can move the segments around to change their order!</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Limits Violation Modal -->
  <ng-container *ngIf="showLimitsViolationModal">
    <div class="modal-backdrop">
      <div class="modal frosted-glass-modal">
        <div class="modal-header warning-header">
          <div class="warning-icon-circle">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <span class="warning-pill">Account Limit Exceeded</span>
        </div>
        <div class="main-warning-message">
          <ng-container [ngSwitch]="limitsModalReason">
            <ng-container *ngSwitchCase="'roster'">
              <span>
                Your account has exceeded free limits:
                <span *ngIf="limitsStatus && limitsStatus.violations.captains">{{ limitsStatus.currentCounts.captains }} captains (limit: {{ limitsStatus.limits.maxCaptains }})</span>
                <span *ngIf="limitsStatus && limitsStatus.violations.teamMembers">{{ limitsStatus.currentCounts.teamMembers }} team members (limit: {{ limitsStatus.limits.maxTeamMembers }})</span>
              </span>
            </ng-container>
            <ng-container *ngSwitchCase="'segment'">
              <span>
                You have too many segments ({{ limitsStatus ? limitsStatus.currentCounts.segments : 0 }} / {{ limitsStatus ? limitsStatus.limits.maxSegments : 0 }} limit).
              </span>
            </ng-container>
            <ng-container *ngSwitchCase="'set'">
              <span>
                You have too many sets ({{ limitsStatus ? limitsStatus.currentCounts.sets : 0 }} / {{ limitsStatus ? limitsStatus.limits.maxSets : 0 }} limit).
              </span>
            </ng-container>
          </ng-container>
        </div>
        <div class="modal-body">
          <ng-container [ngSwitch]="limitsModalReason">
            <ng-container *ngSwitchCase="'roster'">
              <div class="modal-info">
                Please edit roster or upgrade to Pro to continue using Sway.
              </div>
            </ng-container>
            <ng-container *ngSwitchCase="'segment'">
              <div class="modal-info">
                Please delete a segment or upgrade to Pro to access <b>{{ limitsModalTargetName }}</b>.
              </div>
            </ng-container>
            <ng-container *ngSwitchCase="'set'">
              <div class="modal-info">
                You have {{ limitsStatus ? (limitsStatus.currentCounts.sets - limitsStatus.limits.maxSets) : 0 }} additional sets. Delete them or upgrade to view your segments.
              </div>
            </ng-container>
          </ng-container>
        </div>
        <div class="modal-actions">
          <button class="edit-roster-btn" (click)="goToEditRoster()" *ngIf="limitsModalReason === 'roster'">
            Edit Roster
          </button>
          <button class="close-btn" (click)="closeLimitsViolationModal()" *ngIf="limitsModalReason !== 'roster'">Close</button>
          <button class="upgrade-pro-btn" (click)="goToMembershipPlan()">
            <i class="fas fa-star star"></i>
            Upgrade to Pro
          </button>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- Join Code Modal -->
  <div class="modal-backdrop" *ngIf="showJoinCodeModal">
    <div class="modal frosted-glass-modal join-code-modal">
      <div class="modal-header">
        <h2>Manage Join Code</h2>
        <button type="button" class="modal-close-btn" (click)="closeJoinCodeModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="join-code-section">
          <label class="form-label">Team Join Code</label>
          <div class="join-code-input-group">
            <input 
              type="text" 
              [(ngModel)]="editJoinCodeValue" 
              maxlength="7" 
              class="join-code-input"
              placeholder="Enter 7-character code"
              (input)="validateJoinCodeInput()"
              (keyup)="validateJoinCodeInput()"
              style="text-transform: uppercase;"
            />
            <button 
              type="button" 
              class="generate-code-btn" 
              (click)="generateNewJoinCode()"
              title="Generate new code">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
          <div class="join-code-error" *ngIf="joinCodeError">{{ joinCodeError }}</div>
        </div>

        <div class="join-code-actions">
          <button 
            type="button" 
            class="copy-code-btn" 
            (click)="copyJoinCode()"
            title="Copy to clipboard">
            <i class="fas fa-copy"></i> Copy Code
          </button>
          <button 
            type="button" 
            class="share-code-btn" 
            (click)="shareJoinCode()"
            title="Share code">
            <i class="fas fa-share-alt"></i> Share
          </button>
        </div>

        <div class="join-code-info">
          <p><i class="fas fa-info-circle"></i> Share this code with team members so they can join your team.</p>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" (click)="closeJoinCodeModal()" class="btn-cancel">Cancel</button>
        <button 
          type="button" 
          (click)="saveJoinCodeEdit()" 
          class="btn-save"
          [disabled]="!editJoinCodeValue || editJoinCodeValue.length !== 7 || editJoinCodeValue === team?.joinCode">
          Save Changes
        </button>
      </div>
    </div>
  </div>
</div> 