<div class="edit-roster-container">
  <div class="content-wrapper">
    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <h1>Team Members</h1>
        <p>Manage your team roster, styles, skill ratings. Dancers will input their own height when they log in.</p>
      </div>
      <button 
        (click)="navigateBack()" 
        class="close-button"
        aria-label="Close">
        Back to Dashboard
      </button>
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="error-message">
      {{ errorMessage }}
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value">{{ members.length }}</div>
        <div class="stat-label">Total Members</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ styles.length }}</div>
        <div class="stat-label">Dance Styles</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ getCaptainCount() }}</div>
        <div class="stat-label">Captains</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{{ getAverageSegmentsPerPerformer() }}</div>
        <div class="stat-label">Avg Segments per Performer</div>
      </div>
    </div>

    <div class="main-grid">
      <!-- Dance Styles Management -->
      <div class="styles-sidebar">
        <div class="sidebar-header">
          <h2>
            <i class="fas fa-music"></i>
            Dance Styles
          </h2>
        </div>
        <div class="sidebar-content">
          <div class="styles-list">
            <div *ngFor="let style of styles; let i = index" class="style-item" [class.new-style]="style.isNew">
              <div class="style-info">
                <input
                  *ngIf="style.isNew"
                  type="color"
                  [(ngModel)]="style.color"
                  class="style-color-input">
                <div 
                  *ngIf="!style.isNew"
                  class="style-color" 
                  [style.background-color]="style.color"></div>
                
                <!-- Editable name for new styles -->
                <input
                  *ngIf="style.isNew"
                  [(ngModel)]="style.name"
                  (keyup.enter)="saveNewStyle(style)"
                  (blur)="!style.name.trim() ? cancelNewStyle(style) : null"
                  (click)="$event.stopPropagation()"
                  (input)="adjustInputWidth($event)"
                  placeholder="Enter style name..."
                  type="text"
                  class="inline-style-input seamless-input"
                  [style.width.ch]="style.name.length + 1">
                
                <!-- Editable name for existing styles in edit mode -->
                <input
                  *ngIf="!style.isNew && style.isEditing"
                  [(ngModel)]="style.name"
                  (ngModelChange)="saveEditedStyle(style, i)"
                  (blur)="finishEditingStyle(style)"
                  (keyup.enter)="finishEditingStyle(style)"
                  (click)="$event.stopPropagation()"
                  (input)="adjustInputWidth($event)"
                  type="text"
                  class="inline-style-input seamless-input"
                  [style.width.ch]="style.name.length + 1"
                  [id]="'style-name-input-' + i">
                
                <!-- Clickable name for existing styles not in edit mode -->
                <span
                  *ngIf="!style.isNew && !style.isEditing"
                  class="style-name clickable"
                  (click)="startEditingStyle(style, i); $event.stopPropagation()"
                  title="Click to rename">
                  {{ style.name }}
                </span>
              </div>
              
              <div class="style-actions">
                <!-- Actions for new styles -->
                <div *ngIf="style.isNew" class="new-style-actions">
                  <button
                    (click)="saveNewStyle(style)"
                    [disabled]="!style.name.trim()"
                    class="save-btn">
                    <i class="fas fa-check"></i>
                  </button>
                  <button
                    (click)="cancelNewStyle(style)"
                    class="cancel-btn">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                
                <!-- Actions for existing styles not in edit mode -->
                <div *ngIf="!style.isNew && !style.isEditing" class="existing-style-actions">
                  <button
                    (click)="deleteStyle(i)"
                    class="delete-button">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="add-style-section">
            <button
              (click)="addBlankStyle()"
              class="add-style-button">
              <i class="fas fa-plus"></i>
              Add Dance Style
            </button>
          </div>
        </div>
      </div>

      <!-- Team Members List -->
      <div class="members-section">
        <div class="section-header">
          <h2>Team Roster</h2>
          <div class="header-buttons">
            <!-- Single Add Member Button -->
            <button
              (click)="addBlankMember()"
              class="add-member-btn">
              <i class="fas fa-user"></i>
              Add Member
            </button>

            <!-- Bulk Add Members Button -->
            <button
              (click)="showBulkAddDialog = true"
              class="bulk-add-btn">
              <i class="fas fa-users"></i>
              Bulk Add Members
            </button>


          </div>
        </div>
        <div class="section-content">
          <div class="members-list">
            <div *ngFor="let member of members" class="member-card" [class.new-member]="member.isNew">
              
              <!-- Avatar & Basic Info -->
              <div class="member-avatar">
                {{ member.name.charAt(0) || '?' }}
              </div>
              <div class="member-info">
                <!-- Editable name for new members -->
                <div class="member-name" *ngIf="member.isNew">
                   <input 
                     [(ngModel)]="member.name" 
                     placeholder="Enter member name..."
                     class="inline-name-input"
                     (keyup.enter)="saveNewMember(member)"
                     (blur)="!member.name.trim() ? cancelNewMember(member) : null">
                   <i *ngIf="member.captain" class="fas fa-crown crown-icon"></i>
                </div>

                <!-- Editable name for existing members in edit mode -->
                <div class="member-name" *ngIf="!member.isNew && member.isEditingName">
                  <input 
                    [(ngModel)]="member.name"
                    (ngModelChange)="saveEditedMemberName(member)"
                    (blur)="finishEditingMemberName(member)"
                    (keyup.enter)="finishEditingMemberName(member)"
                    (click)="$event.stopPropagation()"
                    (input)="adjustInputWidth($event)"
                    class="inline-name-input seamless-input"
                    type="text"
                    [style.width.ch]="member.name.length + 1"
                    [id]="'member-name-input-' + member._id"
                    #nameInput>
                  <i 
                    class="fas fa-crown crown-icon clickable"
                    [class.captain]="member.captain"
                    [class.not-captain]="!member.captain"
                    (click)="toggleCaptainStatus(member); $event.stopPropagation()"
                    [title]="member.captain ? 'Click to remove captain status' : 'Click to make captain'"
                    ></i>
                </div>

                <!-- Clickable name for existing members not in edit mode -->
                <div class="member-name" *ngIf="!member.isNew && !member.isEditingName">
                  <span 
                    class="member-name-text clickable"
                    (click)="startEditingMemberName(member); $event.stopPropagation()"
                    title="Click to rename">
                    {{ member.name }}
                  </span>
                  <i 
                    class="fas fa-crown crown-icon clickable"
                    [class.captain]="member.captain"
                    [class.not-captain]="!member.captain"
                    (click)="toggleCaptainStatus(member)"
                    [title]="member.captain ? 'Click to remove captain status' : 'Click to make captain'"
                    ></i>
                </div>
                <div class="member-details">
                  <span 
                    class="height-display"
                    [class.draggable]="!member.isNew"
                    (mousedown)="startHeightDrag($event, member)"
                    [title]="member.isNew ? 'Height editing disabled for new members' : 'Click and drag to adjust height'"
                    >{{ member.feet || 5 }}'{{ member.inches || 6 }}"</span>â€¢ {{ getMemberSegmentCount(member) }} seg
                </div>
              </div>

              <!-- Style Ratings -->
              <div class="member-skills">
                <div class="skills-grid">
                  <div *ngFor="let style of styles" class="skill-item">
                    <div class="skill-color" [style.background-color]="style.color"></div>
                    <span class="skill-name">{{ style.name }}</span>
                    <div class="skill-stars">
                      <i *ngFor="let star of [1,2,3,4,5]" 
                         class="fas fa-star clickable-star"
                         [class.text-yellow-400]="star <= (member.skillLevels[style.name.toLowerCase()] || 0)"
                         [class.text-gray-400]="star > (member.skillLevels[style.name.toLowerCase()] || 0)"
                         (click)="updateMemberSkill(member, style.name, star)"
                         [title]="'Set ' + style.name + ' skill to ' + star + ' stars'"></i>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Actions -->
              <div class="member-actions">
                <!-- Actions for new members -->
                <div *ngIf="member.isNew" class="new-member-actions">
                  <button
                    (click)="saveNewMember(member)"
                    [disabled]="!member.name.trim()"
                    class="save-btn">
                    <i class="fas fa-check"></i>
                  </button>
                  <button
                    (click)="cancelNewMember(member)"
                    class="cancel-btn">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                
                <!-- Actions for existing members -->
                <div *ngIf="!member.isNew" class="existing-member-actions">
                  <button
                    (click)="removeMember(member)"
                    class="delete-btn">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Single Add Member Dialog -->
  <div *ngIf="showSingleAddDialog" class="modal-overlay">
    <div class="modal small-modal">
      <div class="modal-header">
        <h3>Add Team Member</h3>
        <button (click)="showSingleAddDialog = false" class="close-button">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-content">
        <div class="form-group">
          <label>Member Name</label>
          <input
            [(ngModel)]="singleMemberName"
            (keyup.enter)="addSingleMember()"
            placeholder="Enter member name"
            type="text"
            #singleMemberInput>
        </div>
        <div class="form-buttons">
          <button 
            (click)="addSingleMember()" 
            [disabled]="!singleMemberName.trim()" 
            class="primary-btn">
            Add Member
          </button>
          <button 
            (click)="showSingleAddDialog = false"
            class="secondary-btn">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Add Members Dialog -->
  <div *ngIf="showBulkAddDialog" class="modal-overlay">
    <div class="modal large-modal">
      <div class="modal-header">
        <h3>Bulk Add Team Members</h3>
        <button (click)="showBulkAddDialog = false" class="close-button">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-content">
        <div class="form-group">
          <label>Paste names one per line (Hold shift + return for new line)</label>
          <textarea
            [(ngModel)]="bulkAddText"
            placeholder="John Smith&#10;Jane Doe&#10;Alex Johnson&#10;..."
            rows="8"></textarea>
          <p class="bulk-add-text">
            {{ getBulkAddCount() }} members will be added
          </p>
        </div>
        <div class="form-buttons">
          <button 
            (click)="addMembersFromText()" 
            [disabled]="!bulkAddText.trim()" 
            class="primary-btn">
            <i class="fas fa-users"></i>
            Add {{ getBulkAddCount() }} Members
          </button>
          <button 
            (click)="showBulkAddDialog = false"
            class="secondary-btn">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Member Dialog -->
  <div *ngIf="editingMember" class="modal-overlay">
    <div class="modal large-modal">
      <div class="modal-header">
        <h3>Edit {{ editingMember.name }}</h3>
        <button (click)="closeEditMemberDialog()" class="close-button">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-content">
        <!-- Edit Member Tabs -->
        <div class="tabs">
          <div class="tab-list">
            <button 
              (click)="editMemberTab = 'basic'"
              [class.active]="editMemberTab === 'basic'">
              Basic Info
            </button>
            <button 
              (click)="editMemberTab = 'skills'"
              [class.active]="editMemberTab === 'skills'">
              Skill Ratings
            </button>
          </div>

          <!-- Basic Info Tab -->
          <div *ngIf="editMemberTab === 'basic'" class="tab-content">
            <div class="form-group">
              <label>Name</label>
              <input
                [(ngModel)]="editingMember.name"
                type="text">
            </div>
            <div class="form-group">
              <div class="form-row">
                <div style="flex: 1;">
                  <label>Feet</label>
                  <input
                    type="number"
                    [(ngModel)]="editingMember.feet">
                </div>
                <div style="flex: 1;">
                  <label>Inches</label>
                  <input
                    type="number"
                    [(ngModel)]="editingMember.inches">
                </div>
              </div>
            </div>
            <div class="form-group">
              <div class="form-row">
                <input
                  type="checkbox"
                  [(ngModel)]="editingMember.captain"
                  id="captain-checkbox">
                <label for="captain-checkbox">Team Captain</label>
              </div>
            </div>
            <div class="form-buttons">
              <button 
                (click)="saveEditingMember()" 
                class="success-btn">
                Save Changes
              </button>
            </div>
          </div>

          <!-- Skills Tab -->
          <div *ngIf="editMemberTab === 'skills'" class="tab-content">
            <div class="skill-list">
              <div *ngFor="let style of styles" class="skill-item">
                <div class="skill-info">
                  <div class="skill-color" [style.background-color]="style.color"></div>
                  <span class="skill-name">{{ style.name }}</span>
                </div>
                <div class="star-rating">
                  <button *ngFor="let star of [1,2,3,4,5]"
                    (click)="updateEditingMemberSkill(style.name, star)">
                    <i class="fas fa-star"
                       [class.text-yellow-400]="star <= (editingMember.skillLevels[style.name.toLowerCase()] || 0)"
                       [class.text-gray-300]="star > (editingMember.skillLevels[style.name.toLowerCase()] || 0)"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="form-buttons">
              <button 
                (click)="saveEditingMember()" 
                class="success-btn">
                Save Changes
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div> 