<div class="segment-page-container">
  <div class="top-panel" *ngIf="isCaptain">
    <div class="top-panel-left">
      <div class="segment-logo-container" (click)="navigateToDashboard()">
        <img src="assets/logo.png" alt="Sway Logo" class="segment-logo">
      </div>
      <div class="logo-divider"></div>
      <div class="segment-name">
        {{ segmentName }}
        <span class="last-save-time" *ngIf="lastSaveTime">
          Last saved at {{ lastSaveTime | date:'h:mm:ss a' }}
        </span>
      </div>
    </div>
    <div class="top-panel-controls">
      <label class="roster-add-btn" [class.loading]="isUploadingMusic">
        <input type="file" accept=".mp3,audio/mp3" (change)="onMusicFileSelected($event)" hidden>
        <span class="material-icons" *ngIf="!isUploadingMusic">audio_file</span>
        <span class="material-icons loading-icon" *ngIf="isUploadingMusic">sync</span>
        {{ isUploadingMusic ? 'Uploading...' : 'Add Audio File' }}
      </label>
      <button class="roster-add-btn" (click)="toggleColorBySkill()">
        <span class="material-icons">palette</span>
        Color by Skill
      </button>
      <div class="style-selector-panel" *ngIf="showColorBySkill">
        <div class="selected-style-card" *ngIf="selectedStyle">
          <div class="style-name">{{ selectedStyle.name }}</div>
          <div class="skill-gradient">
            <div class="gradient-section" *ngFor="let i of [1,2,3,4,5]" 
                 [style.background]="getGradientColor(i)">
              {{ i }}
            </div>
          </div>
        </div>
        <div class="style-options" *ngIf="!selectedStyle">
          <button class="style-option" *ngFor="let style of segmentStyles" 
                  (click)="selectStyle(style)"
                  [style.background]="style.color">
            {{ style.name }}
          </button>
        </div>
      </div>
      <label class="roster-add-btn" *ngIf="is3DView">
        <input type="file" accept="video/mp4,video/webm" (change)="onDirectVideoFileSelected($event)" hidden>
        <span class="material-icons">video_library</span>
        Add Backdrop
      </label>
      <button class="roster-add-btn" (click)="toggle3DView()">
        <span class="material-icons">
          {{ is3DView ? 'grid_on' : 'view_in_ar' }}
        </span>
        {{ is3DView ? '2D View' : '3D View' }}
      </button>
      <button class="roster-add-btn" (click)="flipStage()">
        <span class="material-icons">flip</span>
        Flip Stage
      </button>
      <button *ngIf="isCaptain" class="edit-stage-btn" (click)="openEditModal()">
        <span class="material-icons">edit</span> Edit Stage
      </button>
    </div>
  </div>

  <div class="main-content">
    <!-- Collapsible Positioning Tips Tab -->
    <div class="positioning-tips-tab" [class.expanded]="showPositioningTips">
      <!-- Tab Handle -->
      <div class="tips-tab-handle" (click)="togglePositioningTips()">
        <span class="tips-tab-label">Positioning Tips</span>
        <div class="tips-badge" *ngIf="getCurrentSegmentWarnings().length > 0">
          {{ getCurrentSegmentWarnings().length }}
        </div>
      </div>
      
      <!-- Tips Panel -->
      <div class="tips-panel" 
           [class.visible]="showPositioningTips"
           [style.opacity]="showPositioningTips ? '1' : '0'"
           [style.visibility]="showPositioningTips ? 'visible' : 'hidden'">
        <div class="tips-header">
          <span class="material-icons warning-icon">info</span>
          <span class="tips-title">Performer Positioning Tips</span>
        </div>
        <div class="tips-content">
          <div class="tips-empty" *ngIf="getCurrentSegmentWarnings().length === 0">
            <span class="material-icons">check_circle</span>
            <p>No positioning issues detected!</p>
            <small>All performers are positioned consistently across their most recentsegments.</small>
          </div>
          <div class="warning-item" *ngFor="let warning of getCurrentSegmentWarnings()">
            <div class="warning-message">{{ warning.message }}</div>
            <div class="warning-details">
              <span class="segment-info">{{ warning.previousSegment }} → {{ warning.currentSegment }}</span>
              <span class="side-info">{{ warning.previousSide }} → {{ warning.currentSide }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="roster-sidebar" *ngIf="isCaptain">
      <div class="sidepanel-top-line"></div>
      <div class="sidepanel-vertical-line"></div>
      <div class="sidepanel-toggle-buttons">
        <button class="sidepanel-toggle-btn" [class.active]="sidePanelMode === 'roster'" (click)="setSidePanelMode('roster')">Roster Info</button>
        <button class="sidepanel-toggle-btn" [class.active]="sidePanelMode === 'performer'" (click)="setSidePanelMode('performer')">Performer Info</button>
      </div>
      <ng-container *ngIf="sidePanelMode === 'performer'; else rosterPanel">
        <div class="performer-details" *ngIf="selectedPerformer; else noPerformerSelected">
          <div class="performer-header">
            <input type="text" class="performer-name" [(ngModel)]="selectedPerformer.name" (blur)="updatePerformerName()">
            <button class="remove-performer-btn" (click)="removePerformer()">
              <span class="material-icons">delete</span>
            </button>
          </div>
          <div class="performer-info">
            <div class="info-group">
              <button class="conversion-btn" (click)="togglePerformerPairingDropdown()">
                <span class="material-icons">swap_horiz</span>
                Change Performer Pairing
              </button>
              <div class="performer-pairing-dropdown" *ngIf="showPerformerPairingDropdown">
                <div class="dropdown-content">
                  <button class="dropdown-item" (click)="convertToDummy()">
                    <span class="material-icons">person_off</span>
                    Dummy
                  </button>
                  <button class="dropdown-item" *ngFor="let user of availableUsers" 
                          (click)="convertToUser(user)">
                    <span class="material-icons">person</span>
                    {{ user.name }}
                  </button>
                </div>
              </div>
            </div>
            <div class="info-group" *ngIf="!selectedPerformer.isDummy">
              <label>Height</label>
              <div class="height-inputs">
                <div class="height-input-group">
                  <input type="number" 
                         [(ngModel)]="selectedPerformerFeet" 
                         (change)="updatePerformerHeight()"
                         min="3" 
                         max="7" 
                         step="1"
                         class="height-input">
                  <span class="height-unit">ft</span>
                </div>
                <div class="height-input-group">
                  <input type="number" 
                         [(ngModel)]="selectedPerformerInches" 
                         (change)="updatePerformerHeight()"
                         min="0" 
                         max="11" 
                         step="1"
                         class="height-input">
                  <span class="height-unit">in</span>
                </div>
              </div>
            </div>
            <div class="info-group" *ngIf="selectedPerformer.isDummy">
              <div class="dummy-message">
                <span class="material-icons">info</span>
                Pair with a performer to get more features
              </div>
            </div>
          </div>
          <div class="skill-levels" *ngIf="!selectedPerformer.isDummy">
            <div class="skill-group" *ngFor="let style of segmentStyles">
              <div class="skill-header">
                <label>{{style.name}}</label>
                <span class="skill-value">{{getSelectedUserSkillLevel(style.name.toLowerCase())}}/5</span>
              </div>
              <input type="range" 
                     class="skill-slider" 
                     [ngModel]="getSelectedUserSkillLevel(style.name.toLowerCase())"
                     (ngModelChange)="updatePerformerSkill(style.name, $event)"
                     min="1" 
                     max="5"
                     [style.accent-color]="style.color">
            </div>
          </div>
          
          <!-- Custom Color Section -->
          <div class="custom-color-section">
            <div class="color-header">
              <label>Custom Color</label>
              <button *ngIf="selectedPerformer?.customColor" 
                      class="reset-color-btn" 
                      (click)="removePerformerColor(selectedPerformer!.id)"
                      title="Reset to default color">
                <span class="material-icons">refresh</span>
              </button>
            </div>
            <div class="color-picker-container">
              <div class="color-swatches">
                <button *ngFor="let color of customColorOptions"
                        class="color-swatch"
                        [ngStyle]="{'background-color': color, 'border': isSelectedColor(selectedPerformer!, color) ? '3px solid #ffd700' : '2px solid #23263a'}"
                        [class.selected]="isSelectedColor(selectedPerformer!, color)"
                        (click)="updatePerformerColor(selectedPerformer!.id, color)"
                        [attr.aria-label]="color"
                        [title]="color">
                </button>
              </div>
              <div class="color-preview" 
                   [style.background-color]="getPerformerColor(selectedPerformer!)">
              </div>
            </div>
            <div class="color-info">


            </div>
          </div>
        </div>
        <ng-template #noPerformerSelected>
          <div class="performer-details-empty">Select a performer to view details</div>
        </ng-template>
      </ng-container>
      <ng-template #rosterPanel>
        <div class="roster-top-panel">
          <div class="roster-header">
            <h3>Performers</h3>
          </div>
          <!-- Performers List -->
          <div class="performers-list">
            <div class="performer-item" *ngFor="let performer of sortedPerformers; let i = index" 
                 [class.selected]="selectedPerformerIds.has(performer.id)"
                 (click)="selectPerformer(performer)">
              <span class="performer-number">{{i + 1}}</span>
              <span class="performer-name">{{performer.name}}</span>
            </div>
          </div>
          <!-- Add Performer Row -->
          <div class="add-performer-row-link" (click)="toggleAddPerformerDropdown()">
            Add Performer <span class="plus-sign">+</span>
          </div>
          <hr class="add-performer-divider" />
          <div *ngIf="showAddPerformerDropdown" class="add-performer-dropdown">
            <div class="dropdown-content">
              <button class="dropdown-item" (click)="addDummyPerformer()">
                <span class="material-icons">person_add</span>
                Add Dummy Performer
              </button>
              <button class="dropdown-item" *ngFor="let member of sortedTeamRoster" 
                      (click)="addPerformerFromRoster(member)">
                <span class="material-icons">person</span>
                {{ member.name }}
              </button>
            </div>
          </div>
        </div>
      </ng-template>
    </div>
    <div class="content-area">
      <div class="stage-container">
        <div #stageRef class="stage-area" *ngIf="!is3DView" (click)="onStageClick($event)" 
             [style.height.px]="stageGridHeightPx"
             [style.transform]="getStageTransform()">
          <div class="stage-header-center">
            <div class="formation-title" *ngIf="formations[playingFormationIndex]">
              F {{ playingFormationIndex + 1 }}
            </div>
            <div class="stage-label">{{ isStageFlipped ? 'FRONTSTAGE' : 'BACKSTAGE' }}</div>
          </div>
          <div class="stage-grid-outer"
               [style.width.px]="stageWidthPx"
               [style.height.px]="stageHeightPx"
               [ngStyle]="getStageStyle()">
            <!-- Spotlight overlay - only show for non-captains -->
            <div class="spotlight-overlay" *ngIf="!isCaptain" [ngStyle]="getSpotlightStyle()"></div>
            
            <!-- SVG for movement lines -->
            <svg class="movement-lines" [style.width.px]="stageWidthPx" [style.height.px]="stageHeightPx">
              <!-- Path lines -->
              <path *ngFor="let performer of performers"
                     [attr.d]="getPerformerPath(performer.id)"
                     class="movement-line"
                     [style.display]="getPreviousPosition(performer.id) ? 'block' : 'none'"/>
            </svg>

            <!-- Main grid lines: vertical -->
            <div *ngFor="let x of mainVerticals; let i = index" class="main-vertical" [style.left.px]="x"></div>
            <!-- Vertical grid numbers (bottom of grid) -->
            <div *ngFor="let x of mainVerticals; let i = index"
                 class="grid-number vertical-number"
                 [style.left.px]="x"
                 [style.bottom.px]="-28">
              {{ i - 4 }}
            </div>
            <!-- Main grid lines: horizontal -->
            <div *ngFor="let y of mainHorizontals; let i = index" class="main-horizontal" [style.top.px]="y"></div>
            <!-- Horizontal grid numbers (right of grid) -->
            <div *ngFor="let y of mainHorizontals; let i = index"
                 class="grid-number horizontal-number"
                 [style.top.px]="y"
                 [style.right.px]="-40">
              {{ i }}
            </div>
            <!-- Subgrid lines: vertical -->
            <div *ngFor="let x of subVerticals" class="sub-vertical" [style.left.px]="x"></div>
            <!-- Subgrid lines: horizontal -->
            <div *ngFor="let y of subHorizontals" class="sub-horizontal" [style.top.px]="y"></div>
            <!-- Previous position indicators -->
            <div *ngFor="let performer of performers" 
                 class="performer previous-position"
                 [ngStyle]="getPreviousPositionStyle(performer.id)">
              {{performer.name}}
            </div>
            <!-- Current performers -->
            <div class="performer"
                 *ngFor="let performer of performers"
                 [style]="getPerformerStyleWithColor(performer)"
                 [class.selected]="selectedPerformerIds.has(performer.id)"
                 [class.hovered]="isPerformerHovered(performer)"
                 (mousedown)="onDragStart($event, performer)"
                 (click)="onPerformerClick(performer)"
                 (mouseenter)="onPerformerMouseEnter(performer)"
                 (mouseleave)="onPerformerMouseLeave()"
                 [attr.data-id]="performer.id">
              {{performer.name}}
            </div>
            <!-- Stage border -->
            <div class="stage-border"></div>
          </div>
        </div>
        <div #threeContainer class="three-container" *ngIf="is3DView"></div>
        <div class="stage-position-control" *ngIf="!is3DView">
          <input type="range" 
                 class="stage-position-slider" 
                 min="-300" 
                 max="100" 
                 [value]="stageVerticalOffset" 
                 (pointerdown)="onSliderPointerDown($event)"
                 (pointerup)="onSliderPointerUp($event)"
                 (pointermove)="onSliderPointerMove($event)">
        </div>
      </div>
      <div class="floating-controls">
        <button class="unified-play-btn" *ngIf="signedMusicUrl" (click)="toggleUnifiedPlay()" (touchstart)="initializeMobileAudioContext()">
          <span class="material-icons">{{ isPlaying ? 'pause' : 'play_arrow' }}</span>
        </button>
        <button class="unified-arrow-btn" (click)="prevFormation()">
          <span class="material-icons">chevron_left</span>
        </button>
        <button class="unified-arrow-btn" (click)="onNextFormationClick()">
          <span class="material-icons">chevron_right</span>
        </button>
        <button *ngIf="selectedPerformerIds.size === 2" 
                class="swap-positions-btn" 
                (click)="swapSelectedPerformers()">
          <span class="material-icons">swap_horiz</span>
        </button>
      </div>
      <div class="bottom-panel" [ngClass]="{ 'has-audio': signedMusicUrl }">
        <div class="bottom-panel-main">
          <div class="timeline-audio-stack">
            <div class="formation-timeline-bar simplified-timeline"
                 #timelineBarRef
                 [style.width.px]="waveformWidthPx"
                 style="overflow-x: auto; position: relative;"
                 (mousemove)="onTimelineMouseMove($event)"
                 (mouseleave)="onTimelineMouseLeave()"
                 (click)="onTimelineClick($event)">
              <div class="formation-timeline-row" [style.width.px]="getTimelinePixelWidth()">
                <ng-container *ngFor="let formation of formations; let i = index">
                  <div class="formation-timeline-box"
                       [class.active]="currentFormationIndex === i"
                       (click)="jumpToFormation(i)"
                       (mouseenter)="hoveredFormationIndex = i"
                       (mouseleave)="hoveredFormationIndex = null"
                       [style.width.px]="getFormationPixelWidth(i)">
                    <div class="formation-label">F {{ i + 1 }}</div>
                    <div class="formation-duration">{{ formationDurations[i] | number:'1.1-1' }}s</div>
                    <div *ngIf="isCaptain && i < formations.length - 1" class="formation-drag-handle" (mousedown)="onFormationResizeStart($event, i)"></div>
                  </div>
                  <ng-container *ngIf="i < formations.length - 1">
                    <div class="timeline-transition-bar" [style.width.px]="getTransitionPixelWidth(i)">
                      <span class="transition-label">{{ animationDurations[i] | number:'1.1-1' }}s</span>
                      <div *ngIf="isCaptain" class="transition-drag-handle" (mousedown)="onTransitionResizeStart($event, i)"></div>
                    </div>
                  </ng-container>
                </ng-container>
                <button *ngIf="isCaptain" class="add-formation-btn add-formation-plus" (click)="addFormation()">
                  <span class="material-icons">add</span>
                </button>
              </div>
              <div class="timeline-playhead-container">
                <div class="timeline-playhead" [style.left.px]="getHoveredPlayheadPixel()"></div>
              </div>
            </div>
            <div *ngIf="signedMusicUrl" class="audio-player-bar stage-audio-bar" [style.width.px]="waveformWidthPx">
              <div class="waveform-container" style="display: flex; align-items: center; gap: 12px;">
                <div style="flex: 1; position: relative;">
                  <div class="formation-tracker">
                    <ng-container *ngFor="let formation of formations; let i = index">
                      <div class="formation-tracker-segment"
                           [style.left.%]="getFormationStartPercent(i)"
                           [style.width.%]="getFormationPercent(i)"
                           [class.transition]="false">
                      </div>
                      <div class="formation-tracker-segment transition"
                           *ngIf="i < animationDurations.length"
                           [style.left.%]="getTransitionStartPercent(i)"
                           [style.width.%]="getTransitionPercent(i)">
                      </div>
                    </ng-container>
                  </div>
                  <div id="waveform"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="bottom-panel-actions">
            <div class="timeline-zoom-controls" *ngIf="isCaptain">
              <span class="material-icons">zoom_out</span>
              <input type="range" 
                     [min]="minTimelineZoom" 
                     [max]="maxTimelineZoom" 
                     [step]="timelineZoomStep"
                     [(ngModel)]="timelineZoom"
                     (input)="onTimelineZoomChange($event)"
                     class="timeline-zoom-slider">
              <span class="material-icons">zoom_in</span>
              <span class="zoom-percentage">{{ getTimelineZoomPercentage() }}%</span>
            </div>
            <div class="action-buttons">
              <button *ngIf="isCaptain && currentFormationIndex !== null" class="delete-formation-btn" (click)="deleteFormation(currentFormationIndex)">
                <span class="material-icons">delete</span>
              </button>
              <button *ngIf="isCaptain && currentFormationIndex !== null" class="duplicate-formation-btn" (click)="duplicateFormation(currentFormationIndex)">
                <span class="material-icons">content_copy</span>
              </button>
            </div>
            <div class="time-indicator segment-time-display" *ngIf="signedMusicUrl && isCaptain">
              {{ formatTime(playbackTime) }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="edit-modal-backdrop" *ngIf="showEditModal">
    <div class="edit-modal">
      <h2>Edit Stage</h2>
      <form (ngSubmit)="submitEditModal()">
        <label>Segment Name:
          <input type="text" [(ngModel)]="editSegmentName" name="editSegmentName" required />
        </label>
        <label>Width (ft):
          <input type="number" min="8" max="60" [(ngModel)]="editWidth" name="editWidth" required />
        </label>
        <label>Depth (ft):
          <input type="number" min="8" max="60" [(ngModel)]="editDepth" name="editDepth" required />
        </label>
        <label>Divisions:
          <input type="number" min="1" max="8" [(ngModel)]="editDivisions" name="editDivisions" required />
        </label>
        <div class="styles-section-modal">
          <div style="font-weight: 500; margin-bottom: 6px;">Styles</div>
          <div *ngIf="teamStyles.length === 0" style="color: #888; font-size: 0.95em;">No styles defined for this team.</div>
          <div class="styles-list-modal" *ngIf="teamStyles.length > 0">
            <label *ngFor="let style of teamStyles"
                   class="style-checkbox-modal"
                   [class.selected]="isStyleSelected(style)"
                   (click)="toggleStyleSelection(style)"
                   [style.--style-color]="style.color">
              <span>{{ style.name }}</span>
            </label>
          </div>
        </div>
        <div class="modal-actions">
          <button type="submit" class="save">Save</button>
          <button type="button" (click)="closeEditModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>
 