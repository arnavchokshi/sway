<div class="segment-page-container">
  <div class="top-panel" *ngIf="isCaptain">
    <div class="top-panel-left">
      <!-- Logo -->
      <div class="segment-logo-container" (click)="navigateToDashboard()">
        <img src="assets/logo.png" alt="Sway Logo" class="segment-logo">
      </div>
      
      <!-- Segment Info -->
      <div class="segment-info">
        <span class="segment-name">{{ segmentName }}</span>
        <div class="save-status-container">
          <span class="save-indicator saving" *ngIf="isSaving">
            <div class="save-spinner">
              <div class="spinner"></div>
            </div>
            Saving...
          </span>
          <span class="save-indicator saved" *ngIf="!isSaving">
            Saved
          </span>
        </div>
      </div>
      
      <!-- Segment Navigation -->
      <div class="segment-navigation">
        <button class="nav-segment-btn prev-segment" 
                (click)="navigateToPrevSegment()" 
                [disabled]="!canNavigateToPrevSegment()"
                title="Previous Segment">
          <span class="nav-icon">|◀</span>
          <span class="nav-label">Prev Segment</span>
        </button>
        <button class="nav-segment-btn next-segment" 
                (click)="navigateToNextSegment()" 
                [disabled]="!canNavigateToNextSegment()"
                title="Next Segment">
          <span class="nav-icon">▶|</span>
          <span class="nav-label">Next Segment</span>
        </button>
      </div>
    </div>
    
        <!-- Color by Skill Selection (shows in middle when active) -->
    <div class="top-panel-middle" *ngIf="selectedStyle">
      <div class="selected-skill-display">
        <div class="skill-name">{{ selectedStyle.name }}</div>
        <div class="skill-gradient">
          <div class="gradient-section" *ngFor="let i of [1,2,3,4,5]" 
               [style.background]="getGradientColor(i)">
            {{ i }}
          </div>
        </div>
      </div>
    </div>

    <div class="top-panel-controls">
      <!-- Color by Skill Options (shows when toggled, before Add Audio) -->
      <div class="skill-options-panel" *ngIf="showColorBySkill && !selectedStyle">
        <button class="skill-option" *ngFor="let style of segmentStyles" 
                (click)="selectStyle(style)"
                [style.background]="style.color">
          {{ style.name }}
        </button>
      </div>
      
      <!-- Color by Skill -->
      <button class="control-btn premium-btn animated-btn" (click)="toggleColorBySkill()">
        <span class="material-icons">palette</span>
        Color by Skill
      </button>
      
      <!-- Add Audio -->
      <button class="control-btn primary animated-btn" [class.loading]="isUploadingMusic" (click)="triggerAudioUpload()">
        <span class="material-icons" *ngIf="!isUploadingMusic">upload</span>
        <span class="material-icons loading-icon" *ngIf="isUploadingMusic">sync</span>
        Add Audio
      </button>
      <input type="file" accept=".mp3,.wav,.ogg,.m4a,.aac,.flac,audio/mp3,audio/wav,audio/ogg,audio/mp4,audio/aac,audio/flac" (change)="onMusicFileSelected($event)" hidden #audioFileInput>
      
      <!-- Audio Upload Error Display -->
      <div class="upload-popup upload-error" *ngIf="uploadError">
        <span class="material-icons">error</span>
        <span>{{ uploadError }}</span>
        <button class="close-btn" (click)="dismissUploadError()" aria-label="Close">
          <span class="material-icons">close</span>
        </button>
      </div>
      
      <!-- Audio Upload Success Display -->
      <div class="upload-popup upload-success" *ngIf="uploadSuccess">
        <span class="material-icons">check_circle</span>
        <span>{{ uploadSuccess }}</span>
        <button class="close-btn" (click)="dismissUploadSuccess()" aria-label="Close">
          <span class="material-icons">close</span>
        </button>
      </div>
      
      
      
      <!-- Add Backdrop (only in 3D view, Pro Account Only) -->
      <button class="control-btn animated-btn" *ngIf="is3DView" (click)="handleBackdropClick()">
        <span class="material-icons">video_library</span>
        Add Backdrop
      </button>
      <input type="file" accept="video/mp4,video/webm,video/quicktime" (change)="onDirectVideoFileSelected($event)" hidden #backdropFileInput>
      
        <!-- Pro Account Popup for Backdrop -->
  <div class="pro-popup-backdrop" *ngIf="showProPopup" (click)="closeProPopup()">
    <div class="pro-popup-content" (click)="$event.stopPropagation()">
      <div class="pro-popup-header">
        <span class="material-icons">star</span>
        <h3>Pro Feature</h3>
        <button class="pro-popup-close" (click)="closeProPopup()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="pro-popup-body">
        <p>Backdrop videos are only available for Pro members.</p>
        <p>Upgrade to Pro to add immersive video backdrops to your formations!</p>
      </div>
      <div class="pro-popup-footer">
        <button class="pro-popup-btn secondary" (click)="closeProPopup()">Cancel</button>
        <button class="pro-popup-btn primary" (click)="upgradeToPro()">Upgrade to Pro</button>
      </div>
    </div>
  </div>


      
      <!-- Stage Tools Dropdown -->
      <div class="stage-tools-dropdown">
        <button class="control-btn animated-btn" (click)="toggleStageToolsDropdown($event)">
          Stage Tools
          <span class="material-icons dropdown-arrow" [class.expanded]="showStageToolsDropdown">expand_more</span>
        </button>
        <div class="dropdown-menu" 
             [class.show]="showStageToolsDropdown"
             [style.visibility]="showStageToolsDropdown ? 'visible' : 'hidden'"
             [style.pointer-events]="showStageToolsDropdown ? 'auto' : 'none'">
          <button class="dropdown-item" (click)="toggle3DView()">
            <span class="material-icons">{{ is3DView ? 'view_in_ar' : 'grid_view' }}</span>
            {{ is3DView ? '2D View' : '3D View' }}
          </button>
          <button class="dropdown-item" (click)="flipStage()">
            <span class="material-icons">flip</span>
            Flip Stage
          </button>
          <button class="dropdown-item" (click)="toggleShowTransitions()">
            <span class="material-icons">{{ showTransitions ? 'visibility' : 'touch_app' }}</span>
            Transitions: {{ showTransitions ? 'Always' : 'On Click' }}
          </button>
          <button class="dropdown-item" (click)="navigateToEditRoster()">
            <span class="material-icons">group</span>
            Edit Roster
          </button>
        </div>
      </div>



      <!-- Edit Stage Settings -->
      <button class="control-btn settings-btn animated-btn" (click)="openEditModal()" title="Edit Stage Settings">
        <span class="material-icons">settings</span>
      </button>
    </div>

  </div>

  <div class="main-content">
    <!-- Collapsible Positioning Tips Tab (Always visible for captains) -->
    <div class="positioning-tips-tab" *ngIf="isCaptain" [class.expanded]="showPositioningTips">
      <!-- Tab Handle -->
      <div class="tips-tab-handle" (click)="togglePositioningTips()">
        <span class="tips-tab-label">Positioning Tips</span>
        <div class="tips-badge" *ngIf="isProAccount && getAllCurrentTips().length > 0">
          {{ getAllCurrentTips().length }}
        </div>
      </div>
      
      <!-- Tips Panel -->
      <div class="tips-panel" 
           [class.visible]="showPositioningTips"
           [style.opacity]="showPositioningTips ? '1' : '0'"
           [style.visibility]="showPositioningTips ? 'visible' : 'hidden'">
        <div class="tips-header">
          <span class="material-icons warning-icon">info</span>
          <span class="tips-title">Performer Positioning Tips</span>
        </div>
        <div class="tips-content">
          <ng-container *ngIf="isProAccount; else upgradeToPro">
            <div class="tips-empty" *ngIf="getAllCurrentTips().length === 0">
              <span class="material-icons">check_circle</span>
              <p>No positioning issues detected!</p>
              <small>All performers are positioned optimally in this formation.</small>
            </div>
            <div class="warning-item" *ngFor="let tip of getAllCurrentTips()">
              <div class="warning-message">{{ tip.message }}</div>
              <div class="warning-details">
                <span class="tip-type" [ngClass]="tip.type">
                  <span class="material-icons" *ngIf="tip.type === 'consistency'">sync</span>
                  <span class="material-icons" *ngIf="tip.type === 'mirror_height'">height</span>
                  <span class="material-icons" *ngIf="tip.type === 'skill_position'">star</span>
                  {{ tip.type === 'consistency' ? 'Consistency' : tip.type === 'mirror_height' ? 'Height Gap' : 'Skill Position' }}
                </span>
                <span class="segment-info" *ngIf="tip.type === 'consistency'">
                  {{ tip.details.previousSegment }} → {{ tip.details.currentSegment }}
                </span>
                <span class="side-info" *ngIf="tip.type === 'consistency'">
                  {{ tip.details.previousSide }} → {{ tip.details.currentSide }}
                </span>
              </div>
            </div>
          </ng-container>
          <ng-template #upgradeToPro>
            <div class="tips-empty">
              <span class="material-icons">star</span>
              <p>Upgrade to pro to use this feature</p>
            </div>
          </ng-template>
        </div>
      </div>
    </div>

    <div class="roster-sidebar" *ngIf="isCaptain">
      <div class="sidepanel-top-line"></div>
      <div class="sidepanel-vertical-line"></div>
      <div class="sidepanel-toggle-buttons">
        <button class="sidepanel-toggle-btn" [class.active]="sidePanelMode === 'roster'" (click)="setSidePanelMode('roster')">Roster Info</button>
        <button class="sidepanel-toggle-btn" [class.active]="sidePanelMode === 'performer'" (click)="setSidePanelMode('performer')">Performer Info</button>
      </div>
      <ng-container *ngIf="sidePanelMode === 'performer'; else rosterPanel">
        <div class="performer-details" *ngIf="selectedPerformer; else noPerformerSelected">
          <div class="performer-header">
            <input type="text" class="performer-name" [(ngModel)]="editablePerformerName" (blur)="commitPerformerNameEdit()" (keydown.enter)="commitPerformerNameEdit()">
            <button class="remove-performer-btn" (click)="removePerformer()">
              <ng-container *ngIf="!confirmRemovePerformer">
                <span class="material-icons">delete</span>
              </ng-container>
              <ng-container *ngIf="confirmRemovePerformer">
                <span style="white-space:nowrap">Remove from segment</span>
              </ng-container>
            </button>
          </div>
          <div class="performer-info">
            <div class="info-group">
              <button class="conversion-btn" (click)="togglePerformerPairingDropdown()">
                <span class="material-icons">swap_horiz</span>
                Change Performer Pairing
              </button>
              <div class="performer-pairing-dropdown" *ngIf="showPerformerPairingDropdown">
                <div class="dropdown-content">
                  <button class="dropdown-item" (click)="convertToDummy()">
                    <span class="material-icons">person_off</span>
                    Dummy
                  </button>
                  <button class="dropdown-item" *ngFor="let user of availableUsers" 
                          (click)="convertToUser(user)">
                    <span class="material-icons">person</span>
                    {{ formatPerformerName(user.name) }}
                  </button>
                </div>
              </div>
            </div>
            <div class="info-group" *ngIf="!selectedPerformer.isDummy">
              <label>Height</label>
              <div class="height-inputs">
                <div class="height-input-group">
                  <input type="number" 
                         [ngModel]="selectedPerformerFeet" 
                         (ngModelChange)="selectedPerformerFeet = $event; updatePerformerHeight()"
                         min="3" 
                         max="7" 
                         step="1"
                         class="height-input">
                  <span class="height-unit">ft</span>
                </div>
                <div class="height-input-group">
                  <input type="number" 
                         [ngModel]="selectedPerformerInches" 
                         (ngModelChange)="selectedPerformerInches = $event; updatePerformerHeight()"
                         min="0" 
                         max="11" 
                         step="1"
                         class="height-input">
                  <span class="height-unit">in</span>
                </div>
              </div>
            </div>
            <div class="info-group" *ngIf="selectedPerformer.isDummy">
              <div class="dummy-message">
                <span class="material-icons">info</span>
                Pair with a performer to get more features
              </div>
            </div>
          </div>
          <div class="skill-levels" *ngIf="!selectedPerformer.isDummy">
            <div class="skill-group" *ngFor="let style of segmentStyles">
              <div class="skill-header">
                <label>{{style.name}}</label>
                <span class="skill-value">{{getSelectedUserSkillLevel(style.name.toLowerCase())}}/5</span>
              </div>
              <input type="range" 
                     class="skill-slider" 
                     [ngModel]="getSelectedUserSkillLevel(style.name.toLowerCase())"
                     (ngModelChange)="updatePerformerSkill(style.name, $event)"
                     min="1" 
                     max="5"
                     [style.accent-color]="style.color">
            </div>
          </div>
          
          <!-- Custom Color Section -->
          <div class="custom-color-section">
            <div class="color-header">
              <label>Custom Color</label>
              <button *ngIf="selectedPerformer?.customColor" 
                      class="reset-color-btn" 
                      (click)="removePerformerColor(selectedPerformer!.id)"
                      title="Reset to default color">
                <span class="material-icons">refresh</span>
              </button>
            </div>
            <div class="color-picker-container">
              <div class="color-swatches">
                <button *ngFor="let color of customColorOptions"
                        class="color-swatch"
                        [ngStyle]="{'background-color': color, 'border': selectedPerformer.customColor === color ? '3px solid #ffd700' : '2px solid #23263a'}"
                        [class.selected]="selectedPerformer.customColor === color"
                        (click)="updatePerformerColor(selectedPerformer!.id, color)"
                        [attr.aria-label]="color"
                        [title]="color">
                </button>
              </div>
              <div class="color-preview" 
                   *ngIf="selectedPerformer"
                   [style.background-color]="selectedPerformer.customColor || '#00b4d8'">
              </div>
            </div>
            <div class="color-info">


            </div>
          </div>
        </div>
        <ng-template #noPerformerSelected>
          <div class="performer-details-empty">Select a performer to view details</div>
        </ng-template>
      </ng-container>
      <ng-template #rosterPanel>
        <div class="roster-top-panel">
          <div class="roster-header">
            <h3>Performers in Segment</h3>
          </div>
          
          <!-- Filtering Options -->
          <div class="roster-filters">
            <div class="filter-group">
              <span class="material-icons" title="Name Display" style="font-size:18px;">person</span>
              <select [(ngModel)]="nameDisplayMode" class="filter-select" title="Name Display">
                <option value="first">First</option>
                <option value="first-last-initial">Last Initial</option>
                <option value="full">Full</option>
              </select>
            </div>
            <div class="filter-group">
              <span class="material-icons" title="Order By" style="font-size:18px;" *ngIf="sortBy==='alphabetical'">sort_by_alpha</span>
              <span class="material-icons" title="Order By" style="font-size:18px;" *ngIf="sortBy==='height'">straighten</span>
              <span class="material-icons" title="Order By" style="font-size:18px;" *ngIf="sortBy==='order-added'">calendar_today</span>
              <select [(ngModel)]="sortBy" class="filter-select" title="Order By">
                <option value="alphabetical">Alphabetical</option>
                <option value="height">Height</option>
                <option value="order-added">Date Added</option>
              </select>
            </div>
          </div>
          
          <!-- Performers List -->
          <div class="performers-list">
            <div class="performer-item" *ngFor="let performer of sortedPerformers; let i = index" 
                 [class.selected]="selectedPerformerIds.has(performer.id)"
                 [class.initial-animation]="!hasPlayedInitialAnimation"
                 [style.animation-delay.s]="!hasPlayedInitialAnimation ? (0.8 + i * 0.1) : null"
                 (click)="selectPerformer(performer)">
              <span class="performer-number">{{i + 1}}</span>
              <span class="performer-name">{{formatPerformerName(performer.name)}}</span>
            </div>
          </div>
          <!-- Add Performer Row -->
          <div class="add-performer-row-link" (click)="toggleAddPerformerDropdown()">
            Available Team Members <span class="plus-sign">+</span>
          </div>
          <hr class="add-performer-divider" />
          <div class="add-performer-dropdown" 
               [class.show]="showAddPerformerDropdown"
               [style.visibility]="showAddPerformerDropdown ? 'visible' : 'hidden'"
               [style.pointer-events]="showAddPerformerDropdown ? 'auto' : 'none'">
            <div class="dropdown-content">
              <button class="dropdown-item" (click)="addDummyPerformer()">
                <span class="material-icons">person_add</span>
                Add Dummy Performer
              </button>
              <button class="dropdown-item" *ngFor="let member of availableUsers" 
                      (click)="addPerformerFromRoster(member)">
                <span class="material-icons">person</span>
                {{ formatPerformerName(member.name) }}
              </button>
              
              <!-- Add New User to Roster Section -->
              <div class="add-new-user-section">
                <div class="add-new-user-input-group">
                  <input 
                    type="text" 
                    class="add-new-user-input" 
                    placeholder="name"
                    [(ngModel)]="newPerformerName"
                    (keydown.enter)="addNewPerformerToRoster()"
                    maxlength="50">
                  <button 
                    class="add-to-roster-btn" 
                    (click)="addNewPerformerToRoster()"
                    [disabled]="!newPerformerName.trim()">
                    <span class="material-icons">person_add</span>
                    Add to team
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </ng-template>
    </div>
    <div class="content-area">
      <div class="stage-container">
        <div #stageRef class="stage-area" *ngIf="!is3DView" 
             (click)="onStageClick($event)"
             (mousedown)="onStageMouseDown($event)"
             [style.height.px]="stageGridHeightPx"
             [style.transform]="getStageTransform()">
          <div class="stage-header-center">
            <div class="formation-title" *ngIf="formations[playingFormationIndex]">
              F {{ playingFormationIndex + 1 }}
            </div>
            <div class="stage-label">{{ isStageFlipped ? 'FRONTSTAGE' : 'BACKSTAGE' }}</div>
          </div>
          <div class="stage-grid-outer"
               [style.width.px]="totalStageWidthPx"
               [style.height.px]="stageHeightPx"
               [ngStyle]="getStageStyle()">
            <!-- Spotlight overlay - only show for non-captains -->
            <div class="spotlight-overlay" *ngIf="!isCaptain" [ngStyle]="getSpotlightStyle()"></div>
            
            <!-- Selection rectangle -->
            <div class="selection-rectangle" [ngStyle]="getSelectionStyle()"></div>
            
            <!-- Selection rectangle for multiple performers -->
            <div class="performer-selection-rectangle" [ngStyle]="getSelectionRectangleStyle()"></div>
            
            <!-- Rotation handle for multiple performers -->
            <div class="rotation-handle" 
                 *ngIf="selectedPerformerIds.size >= 2"
                 [ngStyle]="getRotationHandleStyle()"
                 (mousedown)="onRotationStart($event)"
                 title="Drag left/right to rotate selected performers">
              <div class="rotation-slider-track">
                <div class="rotation-slider-thumb" [style.left.%]="getRotationSliderPosition()">
                  <span class="material-icons">rotate_right</span>
                </div>
              </div>
            </div>
            
            <!-- SVG for movement lines -->
            <svg class="movement-lines" [style.width.px]="totalStageWidthPx" [style.height.px]="stageHeightPx">
              <!-- Path lines -->
              <path *ngFor="let performer of performers"
                     [attr.d]="getPerformerPath(performer.id)"
                     class="movement-line"
                     [style.display]="(showTransitions || selectedPerformerForPreviousPosition === performer.id || selectedPerformersForPreviousPosition.has(performer.id)) && getPreviousPosition(performer.id) ? 'block' : 'none'"/>
            </svg>

            <!-- Main grid lines: vertical -->
            <div *ngFor="let x of mainVerticals; let i = index" class="main-vertical" [style.left.px]="x + offstageWidthPx"></div>
            <!-- Vertical grid numbers (bottom of grid) -->
            <div *ngFor="let x of mainVerticals; let i = index"
                 class="grid-number vertical-number"
                 [style.left.px]="x + offstageWidthPx"
                 [style.bottom.px]="-28">
              {{ i - 4 }}
            </div>
            <!-- Main grid lines: horizontal -->
            <div *ngFor="let y of mainHorizontals; let i = index" class="main-horizontal" [style.top.px]="y"></div>
            <!-- Horizontal grid numbers (right of grid) -->
            <div *ngFor="let y of mainHorizontals; let i = index"
                 class="grid-number horizontal-number"
                 [style.top.px]="y"
                 [style.right.px]="-40">
              {{ i }}
            </div>
            <!-- Subgrid lines: vertical -->
            <div *ngFor="let x of subVerticals" class="sub-vertical" [style.left.px]="x + offstageWidthPx"></div>
            <!-- Subgrid lines: horizontal -->
            <div *ngFor="let y of subHorizontals" class="sub-horizontal" [style.top.px]="y"></div>
            
            <!-- Offstage area indicators -->
            <div class="offstage-area left-offstage" 
                 [style.width.px]="offstageWidthPx"
                 [style.height.px]="stageHeightPx">
              <div class="offstage-label">OFFSTAGE LEFT</div>
            </div>
            <div class="offstage-area right-offstage" 
                 [style.left.px]="stageWidthPx + offstageWidthPx"
                 [style.width.px]="offstageWidthPx"
                 [style.height.px]="stageHeightPx">
              <div class="offstage-label">OFFSTAGE RIGHT</div>
            </div>
            
            <!-- Mirror line down the middle when mirror mode is enabled -->
            <div *ngIf="isMirrorModeEnabled" class="mirror-line" [style.left.px]="offstageWidthPx + (stageWidthPx / 2)">
              <div class="mirror-line-dots"></div>
            </div>
            
            <!-- Previous position indicators -->
            <div *ngFor="let performer of performers" 
                 class="performer previous-position"
                 [ngStyle]="getPreviousPositionStyle(performer.id)"
                 [style.display]="(showTransitions || selectedPerformerForPreviousPosition === performer.id || selectedPerformersForPreviousPosition.has(performer.id)) && getPreviousPosition(performer.id) ? 'flex' : 'none'">
            </div>
            <!-- Current performers -->
            <div class="performer"
                 *ngFor="let performer of performers"
                 [style]="getPerformerStyleWithColor(performer)"
                 [class.selected]="selectedPerformerIds.has(performer.id)"
                 [class.hovered]="isPerformerHovered(performer)"
                 [class.loading]="isPerformerSelectionLoading"
                 [class.offstage]="isPerformerOffstage(performer)"
                 (mousedown)="isCaptain && onDragStart($event, performer)"
                 (click)="isCaptain && onPerformerClick(performer)"
                 (mouseenter)="isCaptain && onPerformerMouseEnter(performer)"
                 (mouseleave)="isCaptain && onPerformerMouseLeave()"
                 [attr.data-id]="performer.id">
              {{formatPerformerName(performer.name)}}
              <div *ngIf="isPerformerSelectionLoading" class="loading-spinner"></div>
            </div>
            <!-- Stage border -->
            <div class="stage-border"></div>
          </div>
        </div>
        <div #threeContainer class="three-container" *ngIf="is3DView"></div>
      </div>

      <!-- Control Bar -->
        <app-control-bar
    [currentFormationIndex]="currentFormationIndex"
    [totalFormations]="formations.length"
    [isPlaying]="isPlaying"
    [playbackTime]="playbackTime"
    [totalSegmentDuration]="getTotalSegmentDuration()"
    [timelineZoom]="timelineZoom"
    [minTimelineZoom]="minTimelineZoom"
    [maxTimelineZoom]="maxTimelineZoom"
    [timelineZoomStep]="timelineZoomStep"
    [isCaptain]="isCaptain"
    [canUndo]="canUndo"
    [canRedo]="canRedo"
    [selectedPerformerCount]="selectedPerformerIds.size"
    [isMirrorModeEnabled]="isMirrorModeEnabled"
    [showTransitions]="showTransitions"
    [hasAnyDrafts]="hasAnyDrafts()"
    [isViewingDraft]="isViewingDraft"
    (prevFormation)="onControlBarPrevFormation()"
    (playPause)="onControlBarPlayPause()"
    (nextFormation)="onControlBarNextFormation()"
    (zoomChange)="onControlBarZoomChange($event)"
    (addFormation)="onControlBarAddFormation()"
    (duplicateFormation)="onControlBarDuplicateFormation()"
    (deleteFormation)="onControlBarDeleteFormation()"
    (deleteDraft)="onControlBarDeleteDraft()"
    (createDraft)="onControlBarCreateDraft()"
    (undo)="onControlBarUndo()"
    (redo)="onControlBarRedo()"
    (quickSwap)="onControlBarQuickSwap()"
    (mirrorModeToggle)="onControlBarMirrorModeToggle()"
    (transitionsToggle)="toggleShowTransitions()"
    (draftModeToggle)="onControlBarDraftModeToggle()"
    >
  </app-control-bar>
      <div class="bottom-panel" [ngClass]="{ 'has-audio': signedMusicUrl }">
        <div class="timeline-audio-stack" 
             [class.no-audio]="!signedMusicUrl"
             style="position: relative;">
          <!-- Playhead container now overlays the timeline content exactly -->
          <div class="formation-timeline-bar simplified-timeline"
               [class.has-drafts]="hasAnyDrafts()"
               #timelineBarRef
               style="overflow-x: auto; position: relative;"
               (mousemove)="onTimelineMouseMove($event)"
               (click)="onTimelineClick($event)">
            
            <!-- Clickable seek bar inside the scrollable container -->
            <div class="timeline-seek-bar" 
                 [style.width.px]="getTimelinePixelWidth()"
                 (mousemove)="onTimelineMouseMove($event)"
                 (click)="onTimelineClick($event)"
                 (mouseenter)="onSeekBarMouseEnter()"
                 (mouseleave)="onSeekBarMouseLeave()"
                 title="Click to seek to position">
            </div>
            
            <!-- Draggable triangle cursor positioned directly in timeline container -->
            <div class="timeline-cursor-triangle"
                 [style.left.px]="getPlayheadPixel()"
                 (mousedown)="onCursorDragStart($event)"
                 title="Drag to move cursor">
            </div>
            
            <div class="timeline-playhead-container">
              <!-- Main playhead (actual playback position) -->
              <div class="timeline-playhead" [style.left.px]="getPlayheadPixel()"></div>
              <!-- Ghost playhead (hover preview) -->
              <div *ngIf="isHoveringSeekBar && hoveredTimelineX !== null && !isPlaying" class="timeline-playhead ghost" [style.left.px]="getHoveredPlayheadPixel()"></div>
            </div>
            
            <!-- Draft Row - Only visible when drafts exist -->
            <div class="formation-timeline-row draft-row" 
                 *ngIf="hasAnyDrafts()"
                 [style.width.px]="getTimelinePixelWidth()">
              <ng-container *ngFor="let formation of formations; let i = index">
                <div class="formation-timeline-column" [style.width.px]="getDraftFormationPixelWidth(i)">
                  <!-- Draft formation box -->
                  <div *ngIf="hasDraft(i)" 
                       class="formation-timeline-box draft-formation"
                       [class.active]="currentFormationIndex === i && isViewingDraft"
                       (click)="handleFormationClick(i, true)"
                       (contextmenu)="onFormationRightClick($event, i)"
                       (mouseenter)="hoveredFormationIndex = i"
                       (mouseleave)="hoveredFormationIndex = null">
                    <div class="formation-label">F {{ i + 1 }} Draft</div>
                    <div class="formation-duration">{{ getDraftFormationDuration(i) | number:'1.1-1' }}s</div>
                    <div *ngIf="isCaptain" class="formation-drag-handle" (mousedown)="onDraftFormationResizeStart($event, i)"></div>
                  </div>
                  
                  <!-- Empty space when no draft exists -->
                  <div *ngIf="!hasDraft(i)" class="formation-timeline-box empty-draft-space"></div>
                </div>
                
                <ng-container *ngIf="i < formations.length - 1">
                  <div class="timeline-transition-column" [style.width.px]="getDraftTransitionPixelWidth(i)">
                    <!-- Draft transition (always show, editable if current has a draft) -->
                    <div class="timeline-transition-bar draft-transition"
                         [class.editable]="hasDraft(i)"
                         [class.non-editable]="!hasDraft(i)">
                      <span class="transition-label">{{ getDraftAnimationDuration(i) | number:'1.1-1' }}s</span>
                      <div *ngIf="isCaptain && hasDraft(i)" 
                           class="transition-drag-handle" 
                           (mousedown)="onDraftTransitionResizeStart($event, i)"></div>
                    </div>
                  </div>
                </ng-container>
              </ng-container>
            </div>
            
            <!-- Main Formations Row -->
            <div class="formation-timeline-row main-formations-row" 
                 [style.width.px]="getTimelinePixelWidth()">
              <ng-container *ngFor="let formation of formations; let i = index">
                <div class="formation-timeline-column" [style.width.px]="getFormationPixelWidth(i)">
                  <!-- Main formation box -->
                  <div class="formation-timeline-box main-formation"
                       [class.active]="currentFormationIndex === i && !isViewingDraft"
                       [class.has-draft]="hasDraft(i)"
                       (click)="handleFormationClick(i, false)"
                       (contextmenu)="onFormationRightClick($event, i)"
                       (mouseenter)="hoveredFormationIndex = i"
                       (mouseleave)="hoveredFormationIndex = null">
                    <div class="formation-label">F {{ i + 1 }}</div>
                    <div class="formation-duration">{{ formationDurations[i] | number:'1.1-1' }}s</div>
                    <div *ngIf="isCaptain" class="formation-drag-handle" (mousedown)="onFormationResizeStart($event, i)"></div>
                  </div>
                </div>
                
                <ng-container *ngIf="i < formations.length - 1">
                  <div class="timeline-transition-column" [style.width.px]="getTransitionPixelWidth(i)">
                    <!-- Main transition -->
                    <div class="timeline-transition-bar main-transition">
                      <span class="transition-label">{{ animationDurations[i] | number:'1.1-1' }}s</span>
                      <div *ngIf="isCaptain" class="transition-drag-handle" (mousedown)="onTransitionResizeStart($event, i)"></div>
                    </div>
                  </div>
                </ng-container>
              </ng-container>
              <!-- Add Formation Button at end of timeline -->
              <div *ngIf="isCaptain" class="add-formation-btn-timeline" 
                   (click)="addFormation()" 
                   title="Add Formation">
                <span class="material-icons">add</span>
              </div>
            </div>
            
            <!-- Audio waveform inside the same scrollable container -->
            <div *ngIf="signedMusicUrl" class="audio-waveform-container" [style.width.px]="getTimelinePixelWidth()">
              <div id="waveform" [style.width.px]="getTimelinePixelWidth()"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div *ngIf="isPerformerSelectionLoading" class="loading-overlay">
    <div class="loading-message">
      <div class="loading-spinner-large"></div>
      <span>Updating performer data...</span>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="edit-modal-backdrop" *ngIf="showEditModal">
    <div class="modern-edit-modal">
      <div class="modal-header">
        <div class="modal-title">
          <i class="fas fa-cog"></i>
          <h2>Edit Stage Settings</h2>
        </div>
        <button type="button" class="modal-close-btn" (click)="closeEditModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <form (ngSubmit)="submitEditModal()" class="edit-form">
        <!-- Main Content Row -->
        <div class="form-main-row">
          <!-- Left Side - Name and Dimensions -->
          <div class="form-left">
            <!-- Segment Name -->
            <div class="form-group">
              <label class="form-label">Segment Name <span class="required">*</span></label>
              <input 
                type="text" 
                [(ngModel)]="editSegmentName" 
                name="editSegmentName" 
                required 
                class="form-input"
                placeholder="e.g., Opening Formation, Finale"
              />
            </div>

            <!-- Public/Private Toggle -->
            <div class="form-group">
              <div class="visibility-toggle">
                <div class="toggle-icon">
                  <i class="fas" [class.fa-eye]="editIsPublic" [class.fa-eye-slash]="!editIsPublic"></i>
                </div>
                <div class="toggle-content">
                  <h3>{{ editIsPublic ? 'Public Segment' : 'Private Segment' }}</h3>
                  <p>{{ editIsPublic ? 'Visible to the full team' : 'Only visible to captains' }}</p>
                </div>
                <div class="toggle-switch" (click)="editIsPublic = !editIsPublic">
                  <div class="toggle-track" [class.active]="editIsPublic">
                    <div class="toggle-thumb"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Dimensions -->
            <div class="form-group dimensions-section">
              <label class="form-label">Stage Dimensions</label>
              <div class="dimensions-row">
                <div class="dimension-field">
                  <label class="form-label-small">Width (ft)</label>
                  <input 
                    type="number" 
                    min="15" 
                    max="100" 
                    [(ngModel)]="editWidth" 
                    name="editWidth" 
                    required
                    class="form-input-small"
                  />
                </div>
                <div class="dimension-field">
                  <label class="form-label-small">Depth (ft)</label>
                  <input 
                    type="number" 
                    min="15" 
                    max="100" 
                    [(ngModel)]="editDepth" 
                    name="editDepth" 
                    required
                    class="form-input-small"
                  />
                </div>
                <div class="dimension-field">
                  <label class="form-label-small">Sub-Divisions</label>
                  <input 
                    type="number" 
                    min="0" 
                    max="6" 
                    [(ngModel)]="editDivisions" 
                    name="editDivisions" 
                    required
                    class="form-input-small"
                  />
                </div>
              </div>
              <!-- Error message display -->
              <div class="error-message" *ngIf="editModalError">
                <span class="material-icons">error</span>
                <span>{{ editModalError }}</span>
              </div>
            </div>
          </div>

          <!-- Right Side - Styles -->
          <div class="form-right">
            <div class="form-group">
              <div class="styles-header">
                <label class="form-label">Dance Styles <span class="required">*</span></label>
                <p class="styles-subheader">Select styles to enable skill-based formation views</p>
              </div>

              <div *ngIf="teamStyles.length === 0" class="no-styles-message">
                No styles defined for this team.
              </div>

              <div class="styles-grid-modern" *ngIf="teamStyles.length > 0">
                <div *ngFor="let style of teamStyles" 
                     class="style-badge" 
                     [class.selected]="isStyleSelected(style)"
                     (click)="toggleStyleSelection(style)">
                  <div class="style-circle" [style.background-color]="style.color">
                  </div>
                  <span class="style-name">{{ style.name }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Bottom Row: Action Buttons -->
        <div class="modal-bottom-row">
          <div class="modal-actions-modern">
            <button type="button" (click)="closeEditModal()" class="btn-cancel">Cancel</button>
            <button type="submit" class="btn-save">
              Save Changes
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Formation Context Menu -->
  <div class="formation-context-menu-backdrop" *ngIf="showFormationContextMenu" (click)="closeFormationContextMenu()">
    <div class="formation-context-menu" 
         [style.left.px]="contextMenuPosition.x" 
         [style.top.px]="contextMenuPosition.y"
         (click)="$event.stopPropagation()">
      <button class="context-menu-item" (click)="onContextMenuSplit()">
        <span class="material-icons">content_cut</span>
        <span>Split</span>
      </button>
      <button class="context-menu-item" (click)="onContextMenuDuplicate()">
        <span class="material-icons">content_copy</span>
        <span>Duplicate</span>
      </button>
      <button class="context-menu-item" (click)="onContextMenuCopy()" [disabled]="formations[selectedFormationIndex].length === 0">
        <span class="material-icons">file_copy</span>
        <span>Copy</span>
      </button>
      <button class="context-menu-item" (click)="onContextMenuPaste()" [disabled]="!hasCopiedPerformers">
        <span class="material-icons">content_paste</span>
        <span>Paste</span>
      </button>
      <button class="context-menu-item" (click)="onContextMenuDeleteDraft()" [disabled]="!hasDraft(selectedFormationIndex)">
        <span class="material-icons">delete_sweep</span>
        <span>Delete Draft</span>
      </button>
    </div>
  </div>

  <!-- Membership Plan and Edit Team controls (example, adjust selector as needed) -->
  <div *ngIf="!isIphone">
    <!-- Place the membership plan and edit team button here as normal -->
    <!-- Example: -->
    <!-- <button class="membership-plan-btn">Membership Plan</button> -->
    <!-- <button class="edit-team-btn">Edit Team</button> -->
  </div>
  <div *ngIf="isIphone" class="iphone-only-message" style="text-align:center; color:#e4c31f; font-weight:600; margin: 1.5rem 0;">
    View on laptop for full access to features.
  </div>
</div>
 